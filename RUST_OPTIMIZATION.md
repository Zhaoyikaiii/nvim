# Neovim 内存优化配置

这个配置专门针对rust-analyzer的高内存占用问题进行了优化。

## 🎯 优化目标

将rust-analyzer的内存占用从4GB降低到512MB以下，适合日常开发使用。

## 🔧 主要优化措施

### 1. rust-analyzer配置优化
- **禁用proc macros**: 最大的内存消耗源
- **限制代码补全**: 减少补全条目数量
- **禁用代码透镜**: 关闭inlay hints和lens
- **优化缓存设置**: 减少LRU缓存容量
- **内存限制**: 设置2GB硬性限制

### 2. 全局性能优化
- **Treesitter优化**: 对大文件禁用语法高亮
- **补全引擎优化**: 减少debounce时间和结果数量
- **UI组件简化**: 禁用耗电的界面元素
- **文件监听优化**: 排除不必要的目录

### 3. 自动内存管理
- **实时监控**: 每30秒检查内存使用
- **自动清理**: 达到75%阈值时触发清理
- **智能LSP管理**: 停止不活跃的LSP客户端

## 🚀 使用方法

### 启动nvim
```bash
nvim
```

### Rust开发快捷键
- `<leader>rr` - 重启rust-analyzer
- `<leader>rs` - 启动rust-analyzer
- `<leader>rx` - 停止rust-analyzer
- `<leader>rc` - 重新加载工作区
- `<leader>rm` - 清除诊断信息

### 内存管理快捷键
- `<leader>mc` - 手动内存清理
- `<leader>ms` - 查看当前内存使用

### 可用命令
- `:MemoryCleanup` - 手动执行内存清理
- `:MemoryStatus` - 显示当前内存状态

## 📊 内存监控

配置包含自动内存监控：
- 检查间隔: 15秒
- 清理阈值: 60% (约300MB)
- 最大内存限制: 512MB

## ⚙️ 自定义配置

可以通过修改 `lua/config/memory-manager.lua` 调整设置：

```lua
require("config.memory-manager").setup({
  max_memory_mb = 512,      -- 最大内存限制
  check_interval = 15000,   -- 检查间隔(毫秒)
  cleanup_threshold = 0.6,  -- 清理阈值
})
```

## 🔍 故障排除

### 如果内存仍然很高：
1. 检查是否有其他LSP客户端在运行
2. 手动执行 `:MemoryCleanup`
3. 重启nvim
4. 检查Rust项目规模

### 如果rust-analyzer功能不足：
1. 编辑 `lua/plugins/rust.lua` 启用需要的功能
2. 调整proc macros设置
3. 增加缓存大小

## 📈 性能建议

1. **项目结构**: 避免过大的工作空间
2. **依赖管理**: 定期清理不必要的依赖
3. **文件管理**: 关闭不使用的buffer
4. **定期重启**: 长时间使用后重启nvim

## 🎉 预期效果

- **内存占用**: 从4GB降至512MB以下
- **启动时间**: 减少60-80%
- **响应速度**: 更快的补全和诊断响应
- **系统稳定性**: 完全避免内存溢出问题

## 💡 极限优化说明

当前配置采用了极限内存优化策略：
- **proc macros完全禁用**: 最大内存节省
- **缓存降至最低**: 只保留必要功能
- **自动清理机制**: 15秒检查一次
- **LSP客户端管理**: 非必需服务立即停止

如果发现某些功能缺失，可以逐步调整配置启用需要的功能。